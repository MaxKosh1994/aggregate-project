# Проект: REST API с поддержкой WebSocket и сбором метрик

## Описание проекта

Данный проект представляет собой Backend API для обработки HTTP- и WebSocket-запросов. Основные задачи API:

1. Управление запросами через REST API.
2. Поддержка WebSocket-соединений, что позволяет реализовать двустороннюю связь между клиентом и сервером.
3. Сбор и предоставление системных метрик, формируемых библиотекой `prom-client`, для мониторинга через Prometheus.
4. Документирование API с помощью Swagger, предоставляя удобный интерфейс для тестирования и изучения API.
5. Обработка ошибок и управление несуществующими маршрутами, что обеспечивает стабильное поведение приложения.
6. Реализация отправки данных по логам по cron, записью логов в файл, который доступен по статичному маршруту.
7. Пример декомпозиции серверного кода.
8. Базовое тестирование с помощью `jest` (можно расширять по примеру).
9. Реализация углублённой работы с `sequelize`, а именно: работа с чуть более сложными связями, работа с миграциями на добавление нового поля в таблицу, работа с `aliases` в моделях, работа с хуками в моделях, работа с ренеймингом названий таблиц, работа с получением сортированных данных, работа с `enum`.
10. Реализация некоторых возможностей файловой системы 'fs'.
11. Реализация выставления лимитов на количество запросов на сервер.
12. Реализация загрузки файлов на сервер с помощью `multer`.

Этот проект реализован для агрегации технологий, которые предоставляет Эльбрус, в одном проекте, так же он служит референсом для реализации разных фич, примером некоторых хороших практик, мини-примером для реализации функционала сверх программы Эльбрус. На основе этого проекта можно писать неплохие пэт-проекты для резюме, отрабатывать навыки в написании backend-приложений на `express`.

---

# Основные технологии, используемые в проекте, и их применение в проекте (package.json)

## 1. Node.js

- Роль: Node.js — это среда выполнения серверного JavaScript, основанная на движке V8. Она позволяет создавать высокопроизводительные приложения благодаря своей событийно-ориентированной модели.
- Применение в проекте:
  - Node.js служит платформой для запуска серверных приложений.
  - Позволяет обрабатывать большое количество соединений благодаря своей асинхронной модели.
  - Используется для работы с HTTP/HTTPS серверами, а также для реализации WebSocket через библиотеку `ws`.
- Официальная документация: [Node.js Documentation](https://nodejs.org/en/docs/).

---

## 2. Express

- Роль: Express — это минималистичный, гибкий веб-фреймворк для создания серверов и управления маршрутизацией HTTP-запросов.
- Применение в проекте:
  - Обработка HTTP-запросов, управление маршрутами и их middleware (такими как CORS, Cookie-parser).
  - Является основой для создания REST API в проекте — маршруты `/metrics`, `/api-docs` и любые пользовательские.
  - Легковесная структура позволяет интегрировать другие модули, такие как `swagger-ui-express`.
- Официальная документация: [Express.js Documentation](https://expressjs.com/).

---

## 3. Prometheus Client (`prom-client`)

- Роль: Библиотека сбора метрик для мониторинга приложения. Поддерживает интеграцию с популярной системой мониторинга Prometheus.
- Применение в проекте:
  - Собирает информацию о таких показателях, как выполнение HTTP-запросов, задержки, загрузка памяти или количество подключений WebSocket-клиентов.
  - Автоматически экспортирует метрики на эндпоинт `/metrics`, откуда уже можно подключить Prometheus для анализа производительности сервера.
- Официальная документация: [prom-client Documentation](https://github.com/siimon/prom-client).

---

## 4. WebSocket (ws)

- Роль: Библиотека `ws` предоставляет интерфейс для работы с протоколом WebSocket, что позволяет реализовывать двустороннюю связь между клиентом и сервером.
- Применение в проекте:
  - Сервер на базе `ws` управляет подключением клиентов к WebSocket.
  - Реализованы кастомные обработчики событий WebSocket, такие как `upgradeCb` и `connectionCb`, которые можно адаптировать для обработки сообщений (чаты, уведомления в реальном времени).
  - Обеспечивает поддержку двусторонней связи без необходимости отправки периодических запросов с клиента.
- Официальная документация: [ws Library Documentation](https://github.com/websockets/ws).

---

## 5. Swagger UI (`swagger-ui-express`, `swagger-jsdoc`)

- Роль: Swagger используется для генерации и предоставления интерактивной документации API.
- Применение в проекте:
  - Генерация документации API в человекочитаемом формате на эндпоинте `/api-docs`.
  - Приложение использует `swagger-jsdoc`, чтобы компилировать описание API в формате OpenAPI из комментариев или YAML-документов.
  - Предоставляет тестовый интерфейс, где разработчики могут легко выполнять запросы к API.
- Документация:
  - [Swagger-UI-Express Documentation](https://github.com/scottie1984/swagger-ui-express)
  - [Swagger-jsdoc Documentation](https://github.com/Surnet/swagger-jsdoc).

---

## 6. Sequelize

- Роль: Sequelize — это ORM для Node.js, которая поддерживает работу с различными реляционными базами данных, включая PostgreSQL, MySQL и SQLite.
- Применение в проекте:
  - Упрощает взаимодействие с базой данных через модели и даёт возможность работать с миграциями, сидерами и транзакциями.
  - Используется для реализации CRUD-операций через описанные модели, которые абстрагируют работу с таблицами.
  - Скрипты в `package.json` для работы с миграциями (`db:migrate`, `db:init`) основаны на инструменте `sequelize-cli`.
- Документация: [Sequelize Documentation](https://sequelize.org/).

---

## 7. CORS (`cors`)

- Роль: Middleware-библиотека для настройки политики контроля доступа между разными источниками (Cross-Origin Resource Sharing).
- Применение в проекте:
  - Позволяет клиентам из других доменов получать доступ к API-серверу.
  - Легкая настройка допустимых доменов, методов и заголовков API.
- Официальная документация: [CORS Middleware](https://github.com/expressjs/cors).

---

## 8. JSON Web Tokens (`jsonwebtoken`)

- Роль: Библиотека для создания и валидации токенов JWT, которые используются для аутентификации и обмена данными.
- Применение в проекте:
  - Реализует токенированную авторизацию, где пользователи могут использовать JWT для доступа к защищённым ресурсам.
  - Используется для шифрования и проверки пользовательских сессий.
- Официальная документация: [jsonwebtoken Documentation](https://github.com/auth0/node-jsonwebtoken).

---

## 9. Bcrypt (`bcrypt`)

- Роль: Библиотека для хэширования паролей, обеспечивающая шифрование на основе алгоритма bcrypt.
- Применение в проекте:
  - Используется для безопасного хранения пользовательских паролей.
  - Во время входа пароли проверяются путём сравнения хэшей.
- Официальная документация: [Bcrypt Documentation](https://www.npmjs.com/package/bcrypt).

---

## 10. Dotenv

- Роль: Позволяет загружать переменные окружения из файла `.env`.
- Применение в проекте:
  - Конфигурация приложения управляется через переменные окружения, такие как порт сервера и ключи шифрования.
  - Обеспечивает удобство управления конфиденциальными данными без их явного указания в коде.
- Официальная документация: [Dotenv Documentation](https://github.com/motdotla/dotenv).

---

## 11. Multer

- Роль: Middleware для загрузки и обработки файлов в приложении.
- Применение в проекте:
  - Используется для обработки форм с загрузкой файлов, таких как изображения профилей или вложения.
  - Обеспечивает настройку путей, где сохраняются загружаемые ресурсы.
- Официальная документация: [Multer Documentation](https://github.com/expressjs/multer).

---

## 12. Nodemon

- Роль: Инструмент для автоматического перезапуска сервера при изменении исходных файлов.
- Применение в проекте:
  - Ускоряет процесс тестирования и разработки, автоматически перезапуская сервер при внесении изменений в код.
- Официальная документация: [Nodemon Documentation](https://github.com/remy/nodemon).

---

## 13. Jest и Supertest

- Роль: Тестирование кода для обеспечения его работоспособности.
  - Jest — для юнит-тестирования серверной логики или отдельных модулей.
  - Supertest — для осуществления интеграционного тестирования REST API.
- Применение в проекте:
  - Тестирование обработчиков REST API, проверки роутов и проверка ограничения доступа.
- Официальная документация:
  - [Jest Documentation](https://jestjs.io/)
  - [Supertest Documentation](https://github.com/visionmedia/supertest).

## 14. Node-cron

- Роль: Библиотека для планирования задач на сервере. Работает по принципу cron-правил, позволяя запускать определённые функции в указанные интервалы времени.
- Применение в проекте:
  - Используется для выполнения периодических задач, таких как очистка кэша, удаление устаревших данных, создание отчетов или рассылка уведомлений.
  - Благодаря удобному синтаксису, функции можно запускать ежеминутно, ежечасно, ежедневно или с любым другим временным интервалом.
- Преимущества:
  - Простое использование и настройка временных параметров.
  - Позволяет выполнять задачи без необходимости ручного запуска.

## 15. Express-rate-limit

- Роль: Middleware для ограничения числа запросов к API от одного клиента за заданное время.
- Применение в проекте:
  - Повышает безопасность и предотвращает злоупотребление ресурсами сервера, например, от DDoS-атак или брута форса (подбора паролей).
  - Гибко настраивается, позволяя задать лимиты на количество запросов за определённый период времени.
- Преимущества:
  - Лёгкая интеграция с `Express` благодаря middleware.
  - Гибкая настройка (например, настройка лимита только для определённых роутов).

## 16. @faker-js/faker

- Роль: Библиотека для генерации фейковых данных, таких как имена, адреса, номера телефонов, электронные письма и многие другие типы данных.
- Применение в проекте:
  - Создаёт заглушки для тестирования API, заполняет базу данных фейковыми данными (сиды). Это полезно для проверки работы функциональности до этапа разработки реальных данных.
  - Генерирует реалистичные имена пользователей, продукты, сообщения и другие сущности.

---

## Как запустить это приложение

Прежде чем запускать приложение, убедитесь, что ваше окружение настроено корректно. Следуйте шагам, описанным ниже.

---

### Шаг 1: Установка зависимостей

Для работы приложение требует установки всех необходимых пакетов из файла `package.json`. Это можно сделать командой:

```console
npm install --legacy-peer-deps
```

После выполнения этой команды в папке проекта появится папка `node_modules`, содержащая все используемые зависимости.

---

### Шаг 2: Создание файла окружения `.env`

Создайте в корне проекта файл `.env` на основе шаблона `.env_example` и добавьте в него настройки приложения. Например:

PORT=3000 # Задаёт порт для прослушивания сервером
NODE_ENV=dev # Указывает целевой режим работы: 'development', 'production' или 'test'
DATABASE_URL=... # URL подключения к базе данных (например, для PostgreSQL или SQLite)
JWT_SECRET=... # Секретный ключ для подписи JWT

Файл `.env` будет использоваться библиотекой `dotenv` для загрузки переменных окружения в приложение.

---

### Шаг 3: Инициализация базы данных

Перед запуском приложения необходимо выполнить миграции для создания структуры базы данных и заполнить её начальными данными (если это предусмотрено).

1. Создайте базу данных:
   Убедитесь, что ваша база данных указана в `DATABASE_URL`, и она уже существует. Если база данных ещё не создана, создайте её с помощью команды, соответствующей выбранной СУБД (например, PostgreSQL, MySQL).

```console
   npm run db:init
```

2. Для сброса базы данных (удаление всех данных и повторного накатывания миграций и сидов) воспользуйтесь следующей последовательностью:

```console
   npm run db:reset
```

Скрипт выполняет операции очистки базы, миграций и запуска сидеров.

Теперь база данных настроена для работы приложения.

---

### Шаг 4: Запуск сервера

Приложение предлагает несколько способов запуска в зависимости от целей использования.

#### 1. Запуск в режиме разработки:

Для разработки используйте `nodemon`, который автоматически перезагружает сервер при вносимых изменениях:

```console
   npm run dev
```

Этот режим удобен для быстрой разработки и тестирования.

#### 2. Запуск в production-режиме:

Для развертывания на реальном сервере используйте стандартизированный запуск:

```console
   npm run start
```

В этом случае сервер запускается без отслеживания изменений, оптимально для использования в боевых условиях.

---

### Шаг 5: Проверка работы

После успешного запуска сервер будет доступен по адресу `http://localhost:<PORT>`, где `<PORT>` — это номер порта, указанный в файле `.env`. Например, если `PORT=3000`, сервер будет доступен на `http://localhost:3000`.

#### Пример доступных ресурсов:

1. REST API:

   - `GET /metrics` — возвращает метрики сервера для мониторинга.
   - `GET /api-docs` — доступ к Swagger-документации приложения.
   - Дополнительные эндпоинты и их описание представлены в Swagger UI.

2. WebSocket-сервер:
   Используйте WebSocket-клиент, чтобы установить соединение с сервером.
   При подключении сервер вызывает кастомные обработчики событий (`connectionCb`, `messageCb`), позволяя взаимодействовать в реальном времени.

---

## Детали файла package.json

Файл `package.json` обеспечивает управление зависимостями и настройкой полезных скриптов. Некоторые доступные команды:

- `"start"`: Запускает сервер в продакшн-режиме через Node.js.
- `"start:dev"`: Использует `nodemon` для запуска в режиме разработки.
- `"db:migrate"`: Применяет миграции к базе данных.
- `"db:seed"`: Заполняет базу данных начальными тестовыми данными.
- `"db:reset"`: Полностью сбрасывает структуру и контент базы данных.
- `"lint"`: (опционально) Проверяет код на соответствие стандартам с использованием `eslint`.

---

## Дополнительная информация

1. Мониторинг и метрики:
   Эндпоинт `/metrics` предоставляет данные для мониторинга производительности:

   - Использование памяти.
   - Время задержки обработки запросов.
   - Метрики WebSocket соединений (если настроены кастомные события).

2. Планировщик задач:
   Планирование задач осуществляется через `node-cron`. Пример используемых в проекте задач:

   - Очистка устаревших данных.
   - Отправка напоминаний пользователям.

3. Производительность API:
   Для защиты от атак, таких как DDoS, используется `express-rate-limit`. Это предотвращает вызов большого числа запросов одним клиентом.

4. Генерация тестовых данных:
   `@faker-js/faker` позволяет автоматически генерировать случайные данные для различных целей:
   - Наполнение базы данными примерных пользователей (`db:seed`).
   - Создание фейковых данных для тестов API.

---
